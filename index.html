<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bragante Agro</title>
    
    <meta name="theme-color" content="#0a3d1d">
    <link rel="manifest" href="manifest.json">

    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script> 

    <style>
        :root {
            --verde-escuro: #0a3d1d;
            --verde-claro: #2e7d32;
            --vermelho-alerta: #c62828;
            --cinza-pendente: #64748b;
            --neutro-bg: #f1f5f9;
            --neutro-borda: #cbd5e1;
            --texto-principal: #1e293b;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--neutro-bg); margin: 0; padding: 0; color: var(--texto-principal); display: flex; justify-content: center; } 
        .app-container { width: 100%; max-width: 500px; background-color: #f8fafc; min-height: 100vh; padding: 15px; box-sizing: border-box; }
        .header { text-align: center; margin-bottom: 20px; }
        .header h1 { margin: 0; font-size: 22px; font-weight: 900; text-transform: uppercase; }
        .header .bragante { color: var(--verde-escuro); }
        .header .agro { color: var(--verde-claro); }
        
        .card { background: #ffffff; padding: 16px; border-radius: 10px; border: 1px solid var(--neutro-borda); margin-bottom: 12px; }
        .section-title { font-size: 11px; font-weight: 700; color: var(--verde-escuro); text-transform: uppercase; margin-bottom: 12px; }
        
        input, select, textarea { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--neutro-borda); font-size: 14px; outline: none; box-sizing: border-box; background: white; }
        
        /* ForÃ§a visualmente */
        .force-cap { text-transform: capitalize; }

        .grid-prod { display: grid; grid-template-columns: 2fr 1fr 1fr 30px; gap: 8px; margin-bottom: 8px; align-items: center; }
        button { cursor: pointer; border-radius: 6px; font-weight: 600; font-size: 11px; text-transform: uppercase; border: none; }
        .btn-main { background: var(--verde-escuro); color: white; padding: 14px; width: 100%; margin-top: 10px; font-size: 13px; }
        .btn-add { background: transparent; color: var(--verde-claro); border: 1px dashed var(--verde-claro); padding: 9px; margin-bottom: 12px; width: 100%; }
        
        .pedido-item { background: white; padding: 14px; border-radius: 10px; margin-bottom: 12px; border: 1px solid var(--neutro-borda); position: relative; border-left: 6px solid var(--cinza-pendente); }
        .status-container { margin-top: 12px; display: flex; gap: 8px; }
        .badge { font-size: 9px; font-weight: 700; padding: 4px 8px; border-radius: 4px; text-transform: uppercase; }
        .badge-pendente { background-color: #f1f5f9; color: #64748b; }
        .badge-sucesso { background-color: #f0fdf4; color: #166534; }

        .btn-nav-group { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; margin-bottom: 10px; }
        .btn-nav { background: #64748b; color: white; padding: 12px 5px; font-size: 8.5px; }
        .btn-nav.active { background: var(--verde-escuro); }
        
        .actions { display: flex; gap: 6px; margin-top: 12px; }
        .btn-mini { flex: 1; padding: 10px; font-size: 10px; background: #f8fafc; border: 1px solid var(--neutro-borda); }
        
        .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:100; align-items:center; justify-content:center; }
        .modal-content { background:white; padding:20px; border-radius:12px; width:90%; max-width: 300px; text-align: center; }
        #alerta-novo-pedido { display: none; position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: var(--verde-claro); color: white; padding: 12px 24px; border-radius: 30px; z-index: 1000; font-size: 12px; font-weight: bold; }
    </style>
</head>
<body>

    <div id="alerta-novo-pedido">ðŸ”” NOVO PEDIDO RECEBIDO!</div>

    <div class="app-container">
        <div class="header">
            <h1><span class="bragante">BRAGANTE</span> <span class="agro">AGRO</span></h1>
        </div>

        <div class="card">
            <div class="section-title">NOVO PEDIDO</div>
            <div style="display: flex; gap: 10px; margin-bottom: 12px;">
                <div style="flex: 0 0 125px;"><label style="font-size:10px;">Data</label><input type="date" id="data"></div>
                <div style="flex: 1;">
                    <label style="font-size:10px;">Cliente</label>
                    <select id="cliente" onchange="verificarNovoCliente(this)">
                        <option value="">Selecione...</option>
                        <option value="NOVO_CLIENTE">+ NOVO CLIENTE...</option>
                    </select>
                </div>
            </div>
            <div id="container-produtos"></div>
            <button class="btn-add" onclick="adicionarLinhaProduto()">+ Adicionar Item</button>
            <textarea id="descricao" rows="2" placeholder="ObservaÃ§Ãµes..." autocapitalize="sentences"></textarea>
            <input type="hidden" id="edit-id">
            <button class="btn-main" onclick="salvarPedido()">SALVAR PEDIDO</button>
        </div>

        <div class="btn-nav-group">
            <button id="nav-entregas" class="btn-nav active" onclick="mudarModo('entregas')">PENDENTES</button>
            <button id="nav-pagamentos" class="btn-nav" onclick="mudarModo('pagamentos')">PAGAMENTOS</button>
            <button id="nav-todos" class="btn-nav" onclick="mudarModo('todos')">TODOS</button>
        </div>
        
        <div id="listaPedidos"></div>
    </div>

    <div id="modalPagamento" class="modal">
        <div class="modal-content">
            <div class="section-title">Recebimento</div>
            <button onclick="selecionarForma('Pix')" class="btn-main" style="background:#14b8a6;">PIX</button>
            <button onclick="selecionarForma('Dinheiro')" class="btn-main" style="background:#22c55e;">DINHEIRO</button>
            <button onclick="fecharModal()" style="background:none; color:#94a3b8; width:100%; margin-top:15px">FECHAR</button>
        </div>
    </div>

    <script>
        const listaProdutosBase = ["Sorgo em grÃ£os", "Sorgo triturado", "Milho", "Quirela Fina", "Quirela Grossa", "Milheto", "RaÃ§Ã£o Top Mix", "RaÃ§Ã£o Mix", "Outros"];
        let todosPedidos = [], modoAtual = 'entregas', pedidoEmPagamento = null, totalPedidosAnterior = -1;
        const somNotificacao = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');

        const firebaseConfig = {
            apiKey: "AIzaSyCiQh8MEy5SlPCkS8psN0EQ59W2PLKXo8s",
            authDomain: "bragante-agro.firebaseapp.com",
            databaseURL: "https://bragante-agro-default-rtdb.firebaseio.com",
            projectId: "bragante-agro",
            storageBucket: "bragante-agro.firebasestorage.app",
            messagingSenderId: "445413217691",
            appId: "1:445413217691:web:e9b37451c2689a007e7d3e"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // FUNÃ‡ÃƒO DE OURO: Formata enquanto digita e antes de salvar
        function formatarPalavras(texto) {
            return texto.toLowerCase().replace(/(^\w|\s\w)/g, m => m.toUpperCase());
        }

        function adicionarLinhaProduto(p="", q=1, v="") {
            const id = Date.now();
            const div = document.createElement('div');
            div.className = 'grid-prod'; div.id = `linha-${id}`;
            let optionsP = `<option value="">Produto...</option>`;
            listaProdutosBase.forEach(item => { optionsP += `<option value="${item}" ${item === p ? 'selected' : ''}>${item}</option>`; });
            
            div.innerHTML = `
                <select id="prod-${id}" onchange="verificarOutros(this)">${optionsP}</select>
                <input type="number" id="qtd-${id}" value="${q}">
                <input type="number" id="preco-${id}" value="${v}" step="0.01" placeholder="R$">
                <button onclick="document.getElementById('linha-${id}').remove()">Ã—</button>`;
            document.getElementById('container-produtos').appendChild(div);
        }

        function verificarOutros(s) {
            if (s.value === "Outros") {
                let d = prompt("Qual o produto?");
                if (d) {
                    d = formatarPalavras(d);
                    const n = document.createElement("option"); n.value = d; n.text = d; n.selected = true; s.add(n);
                } else s.value = "";
            }
        }

        function verificarNovoCliente(s) {
            if (s.value === "NOVO_CLIENTE") {
                let n = prompt("Nome do novo cliente:");
                if (n) {
                    n = formatarPalavras(n);
                    const o = document.createElement("option"); o.value = n; o.text = n; o.selected = true; s.add(o);
                } else s.value = "";
            }
        }

        function salvarPedido() {
            const cliente = document.getElementById('cliente').value;
            const data = document.getElementById('data').value;
            if(!cliente || !data) return alert("Preencha tudo");

            let itens = [], total = 0;
            document.querySelectorAll('.grid-prod').forEach(l => {
                const id = l.id.split('-')[1];
                const p = document.getElementById(`prod-${id}`).value;
                const q = parseFloat(document.getElementById(`qtd-${id}`).value) || 0;
                const v = parseFloat(document.getElementById(`preco-${id}`).value) || 0;
                if(p) { 
                    itens.push({produto: formatarPalavras(p), qtd: q, preco: v}); 
                    total += (q * v); 
                }
            });

            const dados = { 
                cliente: formatarPalavras(cliente), 
                data, itens, total, 
                entrega: 'Pendente', pagamento: 'Pendente', 
                timestamp: firebase.database.ServerValue.TIMESTAMP 
            };
            
            db.ref('pedidos').push(dados).then(() => {
                document.getElementById('container-produtos').innerHTML = "";
                document.getElementById('cliente').value = "";
                adicionarLinhaProduto();
            });
        }

        db.ref('pedidos').on('value', (snap) => {
            const data = snap.val();
            todosPedidos = [];
            if(data) Object.keys(data).forEach(k => todosPedidos.push({...data[k], id: k}));
            
            if(totalPedidosAnterior !== -1 && todosPedidos.length > totalPedidosAnterior) {
                somNotificacao.play().catch(()=>{});
                document.getElementById('alerta-novo-pedido').style.display='block';
                setTimeout(()=> document.getElementById('alerta-novo-pedido').style.display='none', 4000);
            }
            totalPedidosAnterior = todosPedidos.length;
            
            todosPedidos.sort((a,b) => b.timestamp - a.timestamp);
            atualizarListaClientes();
            listarPedidos();
        });

        function atualizarListaClientes() {
            const sc = document.getElementById('cliente');
            const clientes = [...new Set(todosPedidos.map(p => p.cliente))];
            const originalVal = sc.value;
            sc.innerHTML = '<option value="">Selecione...</option><option value="NOVO_CLIENTE">+ NOVO CLIENTE...</option>';
            clientes.sort().forEach(c => {
                const o = document.createElement('option'); o.value = c; o.text = c;
                if(c === originalVal) o.selected = true;
                sc.add(o);
            });
        }

        function listarPedidos() {
            const lista = document.getElementById('listaPedidos');
            lista.innerHTML = "";
            const filtrados = todosPedidos.filter(p => {
                if(modoAtual === 'entregas') return p.entrega === 'Pendente';
                if(modoAtual === 'pagamentos') return p.pagamento === 'Pendente';
                return true;
            });

            filtrados.forEach(p => {
                lista.innerHTML += `
                <div class="pedido-item" style="border-left-color: ${p.entrega==='Entregue' ? '#2e7d32' : '#c62828'}">
                    <div style="font-size:10px;">${p.data.split('-').reverse().join('/')}</div>
                    <div style="font-weight:800; font-size:16px;">${p.cliente}</div>
                    <div style="font-size:12px;">${p.itens.map(i => `${i.qtd}x ${i.produto}`).join(', ')}</div>
                    <div class="status-container">
                        <span class="badge ${p.entrega==='Entregue'?'badge-sucesso':'badge-pendente'}">Entrega: ${p.entrega}</span>
                        <span class="badge ${p.pagamento==='Pago'?'badge-sucesso':'badge-pendente'}">Pgto: ${p.pagamento}</span>
                    </div>
                    <div style="margin-top:10px; font-weight:bold;">Total: R$ ${p.total.toFixed(2)}</div>
                    <div class="actions">
                        <button class="btn-mini" onclick="confirmarEntrega('${p.id}')">ENTREGA</button>
                        <button class="btn-mini" onclick="abrirPagamento('${p.id}')">PAGAR</button>
                        <button class="btn-mini" style="color:red" onclick="excluirPedido('${p.id}')">EXCLUIR</button>
                    </div>
                </div>`;
            });
        }

        function mudarModo(m) {
            modoAtual = m;
            document.querySelectorAll('.btn-nav').forEach(b => b.classList.remove('active'));
            document.getElementById('nav-'+m).classList.add('active');
            listarPedidos();
        }

        function confirmarEntrega(id) {
            if(confirm("Confirmar a entrega deste pedido?")) {
                db.ref('pedidos/'+id).update({entrega: 'Entregue'});
                const p = todosPedidos.find(x => x.id === id);
                if(p.pagamento === 'Pendente' && confirm("O pedido foi pago?")) abrirPagamento(id);
            }
        }

        function abrirPagamento(id) { pedidoEmPagamento = id; document.getElementById('modalPagamento').style.display='flex'; }
        function fecharModal() { document.getElementById('modalPagamento').style.display='none'; }
        function selecionarForma(f) { db.ref('pedidos/'+pedidoEmPagamento).update({pagamento: 'Pago', forma: f}); fecharModal(); }
        function excluirPedido(id) { if(confirm("Excluir pedido permanentemente?")) db.ref('pedidos/'+id).remove(); }

        document.getElementById('data').valueAsDate = new Date();
        adicionarLinhaProduto();
    </script>
</body>
</html>