<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BRAGANTE AGRO</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        :root { --verde: #0a3d1d; --bg: #f4f7f6; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; padding: 10px; }
        .card { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        
        /* FORÇA MAIÚSCULAS NO CELULAR */
        input, select, textarea { 
            width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ccc; border-radius: 6px; 
            font-size: 16px; box-sizing: border-box; text-transform: uppercase; 
        }
        
        button { width: 100%; padding: 15px; background: var(--verde); color: white; border: none; border-radius: 6px; font-weight: bold; font-size: 16px; margin-top: 10px; }
        .grid-prod { display: grid; grid-template-columns: 2fr 1fr 1fr 40px; gap: 5px; margin-bottom: 10px; }
        .item-pedido { background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 5px solid var(--verde); }
    </style>
</head>
<body>

    <div class="card">
        <h2 style="color:var(--verde); text-align:center;">NOVO PEDIDO</h2>
        
        <label>DATA</label>
        <input type="date" id="f-data">
        
        <label>CLIENTE</label>
        <select id="f-cliente" onchange="novoCliente(this)">
            <option value="">SELECIONE O CLIENTE</option>
            <option value="ADD">+ ADICIONAR NOVO CLIENTE</option>
        </select>
        
        <div id="itens"></div>
        <button type="button" style="background:#666;" onclick="addLinha()">+ PRODUTO</button>
        
        <textarea id="f-obs" placeholder="OBSERVAÇÕES"></textarea>
        <button onclick="salvar()">SALVAR AGORA</button>
    </div>

    <div id="lista-pedidos"></div>

    <script>
        // CREDENCIAIS RECUPERADAS
        const firebaseConfig = {
            apiKey: "AIzaSyCiQh8MEy5SlPCkS8psN0EQ59W2PLKXo8s",
            authDomain: "bragante-agro.firebaseapp.com",
            databaseURL: "https://bragante-agro-default-rtdb.firebaseio.com",
            projectId: "bragante-agro",
            storageBucket: "bragante-agro.firebasestorage.app",
            messagingSenderId: "445413217691",
            appId: "1:445413217691:web:e9b37451c2689a007e7d3e"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // FORÇAR MAIÚSCULA EM TUDO
        function up(texto) { return texto ? texto.toString().toUpperCase().trim() : ""; }

        function addLinha() {
            const id = Date.now();
            const div = document.createElement('div');
            div.className = 'grid-prod';
            div.id = id;
            div.innerHTML = `
                <input type="text" id="p-${id}" placeholder="PRODUTO" oninput="this.value = this.value.toUpperCase()">
                <input type="number" id="q-${id}" placeholder="QTD">
                <input type="number" id="v-${id}" placeholder="R$">
                <button style="background:red; padding:5px;" onclick="document.getElementById('${id}').remove()">X</button>
            `;
            document.getElementById('itens').appendChild(div);
        }

        function novoCliente(s) {
            if(s.value === "ADD") {
                let n = prompt("NOME DO CLIENTE:");
                if(n) {
                    n = up(n);
                    let o = document.createElement("option"); o.value = n; o.text = n; o.selected = true; s.add(o);
                } else s.value = "";
            }
        }

        function salvar() {
            const cliente = up(document.getElementById('f-cliente').value);
            const data = document.getElementById('f-data').value;
            const obs = up(document.getElementById('f-obs').value);

            if(!cliente || !data) { alert("PREENCHA CLIENTE E DATA!"); return; }

            let listaItens = [];
            document.querySelectorAll('.grid-prod').forEach(linha => {
                const id = linha.id;
                const p = up(document.getElementById(`p-${id}`).value);
                const q = document.getElementById(`q-${id}`).value;
                const v = document.getElementById(`v-${id}`).value;
                if(p) listaItens.push({ produto: p, qtd: q, valor: v });
            });

            const novoPedido = { cliente, data, obs, itens: listaItens, status: "PENDENTE" };

            db.ref('pedidos').push(novoPedido)
                .then(() => {
                    alert("SALVO COM SUCESSO!");
                    document.getElementById('itens').innerHTML = "";
                    document.getElementById('f-obs').value = "";
                    addLinha();
                })
                .catch(erro => alert("ERRO AO SALVAR: " + erro.message));
        }

        // MOSTRAR PEDIDOS E ATUALIZAR LISTA DE CLIENTES
        db.ref('pedidos').on('value', snap => {
            const listaDiv = document.getElementById('lista-pedidos');
            const selectCli = document.getElementById('f-cliente');
            const dados = snap.val();
            listaDiv.innerHTML = "";
            
            if(dados) {
                const pedidos = Object.keys(dados).map(k => ({...dados[k], id: k})).reverse();
                
                // Atualizar nomes no Select
                const nomes = [...new Set(pedidos.map(p => p.cliente))].sort();
                const atual = selectCli.value;
                selectCli.innerHTML = '<option value="">SELECIONE O CLIENTE</option><option value="ADD">+ ADICIONAR NOVO CLIENTE</option>';
                nomes.forEach(n => {
                    let o = document.createElement("option"); o.value = n; o.text = n;
                    if(n === atual) o.selected = true;
                    selectCli.add(o);
                });

                pedidos.forEach(p => {
                    listaDiv.innerHTML += `
                        <div class="item-pedido">
                            <strong>${p.cliente}</strong> <br>
                            ${p.data} <br>
                            <small>${p.itens ? p.itens.map(i => i.produto).join(', ') : ''}</small>
                            <button style="background:red; width:80px; padding:5px; float:right;" onclick="excluir('${p.id}')">APAGAR</button>
                            <div style="clear:both;"></div>
                        </div>
                    `;
                });
            }
        });

        function excluir(id) { if(confirm("EXCLUIR?")) db.ref('pedidos/'+id).remove(); }

        document.getElementById('f-data').valueAsDate = new Date();
        addLinha();
    </script>
</body>
</html>