<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Formula√ß√£o - Bragante Agro</title>
    <style>
        :root {
            --verde-escuro: #0a3d1d;
            --verde-claro: #2e7d32;
            --neutro-bg: #f1f5f9;
            --neutro-borda: #cbd5e1;
            --texto-principal: #1e293b;
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--neutro-bg); margin: 0; padding: 15px; color: var(--texto-principal); display: flex; flex-direction: column; align-items: center; }
        
        .header { text-align: center; margin-bottom: 20px; padding-top: 10px; width: 100%; max-width: 450px; }
        .header h1 { margin: 0; font-size: 22px; font-weight: 900; text-transform: uppercase; }
        .header .bragante { color: var(--verde-escuro); }
        .header .agro { color: var(--verde-claro); }
        .header .estancia { margin: 4px 0 2px 0; font-size: 9px; color: #64748b; letter-spacing: 1px; font-weight: bold; text-transform: uppercase; }
        .header .subtitulo { margin: 0; font-size: 11px; color: var(--verde-escuro); font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; }

        .card { background: #ffffff; padding: 16px; border-radius: 10px; border: 1px solid var(--neutro-borda); margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); width: 100%; max-width: 450px; box-sizing: border-box; }
        .section-title { font-size: 11px; font-weight: 700; color: var(--verde-escuro); text-transform: uppercase; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; }
        
        label { display: block; font-size: 10px; font-weight: 600; color: #64748b; margin-bottom: 5px; text-transform: uppercase; }
        input, select { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--neutro-borda); font-size: 14px; outline: none; box-sizing: border-box; background: white; margin-bottom: 10px; }
        
        .grid-ing { display: grid; grid-template-columns: 2fr 1fr 40px; gap: 8px; margin-bottom: 8px; align-items: center; }
        
        .btn { cursor: pointer; border-radius: 6px; font-weight: 600; font-size: 11px; text-transform: uppercase; border: none; transition: 0.2s; }
        .btn-main { background: var(--verde-escuro); color: white; padding: 14px; width: 100%; }
        .btn-add { background: transparent; color: var(--verde-claro); border: 1px dashed var(--verde-claro); padding: 9px; width: 100%; margin-bottom: 10px; }
        .btn-del { color: #f87171; background: none; font-size: 18px; font-weight: bold; }

        .btn-admin-action { background: #f1f5f9; color: #475569; padding: 4px 8px; font-size: 9px; border: 1px solid #cbd5e1; margin-left: 5px; }
        .calc-input { font-size: 22px !important; text-align: center; border: 2px solid var(--verde-escuro) !important; color: var(--verde-escuro); font-weight: 900; height: 60px; }
        
        .resultado-card { background: #f8fafc; border-radius: 8px; padding: 15px; margin-top: 15px; border: 1px solid #e2e8f0; }
        .item-pesagem { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #e2e8f0; }
        .item-pesagem:last-child { border-bottom: none; }
        .item-nome { font-size: 13px; font-weight: 600; color: #475569; }
        .item-valor { font-size: 18px; font-weight: 800; color: var(--verde-escuro); }
        
        .total-badge { font-size: 10px; padding: 2px 8px; border-radius: 4px; background: #fee2e2; color: #991b1b; }
        .total-ok { background: #dcfce7; color: #166534; }

        .btn-acesso { background: #e2e8f0; color: #475569; border: 1px solid #cbd5e1; padding: 10px; width: 100%; margin-bottom: 12px; max-width: 450px; }

        @media print {
            #btn-liberar-admin, .btn, label, select, #meta-kg, .btn-admin-action { display: none !important; }
            .card { border: none; box-shadow: none; }
            .resultado-card { border: 2px solid #000; }
        }
    </style>
</head>
<body>

    <div class="header">
        <h1><span class="bragante">BRAGANTE</span> <span class="agro">AGRO</span></h1>
        <p class="estancia">Est√¢ncia S√£o Francisco do Balsamo</p>
        <p class="subtitulo">Formula√ß√£o de Ra√ß√£o</p>
    </div>

    <button id="btn-liberar-admin" class="btn btn-acesso" onclick="window.liberarAdmin()">‚öôÔ∏è ACESSAR CONFIGURA√á√ÉO</button>

    <div class="card" id="painel-admin" style="display: none;">
        <div class="section-title">
            <span>‚öôÔ∏è Configurar Receita</span>
            <div>
                <button class="btn btn-admin-action" onclick="window.carregarParaEditar()">Editar</button>
                <button class="btn btn-admin-action" style="color:red" onclick="window.excluirReceita()">Excluir</button>
                <span id="total-porcentagem" class="total-badge">0%</span>
            </div>
        </div>
        
        <input type="hidden" id="edit-id">
        <label>Nome da Ra√ß√£o</label>
        <input type="text" id="nome-racao" placeholder="Ex: Ra√ß√£o Top Mix">
        
        <div id="container-ingredientes"></div>
        
        <button class="btn btn-add" onclick="window.addLinhaIngrediente()">+ Adicionar Ingrediente</button>
        <button class="btn btn-main" onclick="window.salvarReceita()">SALVAR NA NUVEM</button>
        <button class="btn" style="width: 100%; margin-top: 10px; background: #f1f5f9;" onclick="window.fecharAdmin()">FECHAR</button>
    </div>

    <div class="card" id="painel-producao">
        <div class="section-title">‚öñÔ∏è Produ√ß√£o e Pesagem</div>
        <label>1. Escolha a Ra√ß√£o</label>
        <select id="select-racao" onchange="window.calcularMistura()">
            <option value="">Carregando...</option>
        </select>
        <label>2. Quantos quilos fazer? (KG)</label>
        <input type="number" id="meta-kg" class="calc-input" placeholder="0" oninput="window.calcularMistura()">
        <div id="resultado-pesagem"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, push, remove } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCyPiiAtA2vVZpCj0IYR1tf2JlOsmqlg3I",
            authDomain: "braganteracao.firebaseapp.com",
            databaseURL: "https://braganteracao-default-rtdb.firebaseio.com",
            projectId: "braganteracao",
            storageBucket: "braganteracao.appspot.com",
            messagingSenderId: "726710858669",
            appId: "1:726710858669:web:1e5092d0948e2291452724"
        };

        const appRacao = initializeApp(firebaseConfig, "RACAO_APP");
        const db = getDatabase(appRacao);
        const formulasRef = ref(db, 'formulas');

        let receitasSalvas = [];
        const SENHA_MESTRA = "1030";

        onValue(formulasRef, (snapshot) => {
            const data = snapshot.val();
            receitasSalvas = data ? Object.keys(data).map(key => ({ ...data[key], fbKey: key })) : [];
            window.atualizarSelects();
        });

        window.liberarAdmin = () => {
            if (prompt("Senha:") === SENHA_MESTRA) {
                document.getElementById('painel-admin').style.display = 'block';
                document.getElementById('btn-liberar-admin').style.display = 'none';
                if(!document.getElementById('container-ingredientes').innerHTML) window.addLinhaIngrediente();
            }
        };

        window.fecharAdmin = () => {
            document.getElementById('painel-admin').style.display = 'none';
            document.getElementById('btn-liberar-admin').style.display = 'block';
            document.getElementById('edit-id').value = "";
            document.getElementById('nome-racao').value = "";
            document.getElementById('container-ingredientes').innerHTML = "";
        };

        window.addLinhaIngrediente = (nome = '', perc = '') => {
            const div = document.createElement('div');
            div.className = 'grid-ing';
            div.innerHTML = `<input type="text" class="ing-nome" value="${nome}"><input type="number" class="ing-perc" value="${perc}" oninput="window.atualizarSoma()"><button class="btn-del" onclick="this.parentElement.remove(); window.atualizarSoma()">√ó</button>`;
            document.getElementById('container-ingredientes').appendChild(div);
            window.atualizarSoma();
        };

        window.atualizarSoma = () => {
            let soma = 0;
            document.querySelectorAll('.ing-perc').forEach(i => soma += Number(i.value || 0));
            document.getElementById('total-porcentagem').innerText = soma + '%';
            document.getElementById('total-porcentagem').className = soma === 100 ? 'total-badge total-ok' : 'total-badge';
            return soma;
        };

        window.salvarReceita = () => {
            const nome = document.getElementById('nome-racao').value;
            const editId = document.getElementById('edit-id').value;
            if(!nome || window.atualizarSoma() !== 100) return alert("Erro nos dados!");
            
            const ingredientes = [];
            document.querySelectorAll('.grid-ing').forEach(l => ingredientes.push({ nome: l.querySelector('.ing-nome').value, porcentagem: Number(l.querySelector('.ing-perc').value) }));
            
            if(editId) set(ref(db, 'formulas/' + editId), { nome, ingredientes });
            else push(formulasRef, { nome, ingredientes });
            
            alert("Sincronizado!");
            window.fecharAdmin();
        };

        // CORRE√á√ÉO: Fun√ß√£o para carregar os dados da receita selecionada para edi√ß√£o
        window.carregarParaEditar = () => {
            const key = document.getElementById('select-racao').value;
            if (!key) return alert("Selecione uma ra√ß√£o para editar!");
            
            const r = receitasSalvas.find(x => x.fbKey === key);
            if (r) {
                document.getElementById('edit-id').value = r.fbKey;
                document.getElementById('nome-racao').value = r.nome;
                const container = document.getElementById('container-ingredientes');
                container.innerHTML = "";
                r.ingredientes.forEach(ing => {
                    window.addLinhaIngrediente(ing.nome, ing.porcentagem);
                });
            }
        };

        window.excluirReceita = () => {
            const key = document.getElementById('select-racao').value;
            if(key && confirm("Excluir de todos os aparelhos?")) remove(ref(db, 'formulas/' + key));
        };

        window.atualizarSelects = () => {
            const s = document.getElementById('select-racao');
            const valorAtual = s.value;
            s.innerHTML = '<option value="">Selecione...</option>';
            receitasSalvas.forEach(r => {
                const o = new Option(r.nome, r.fbKey);
                if(r.fbKey === valorAtual) o.selected = true;
                s.add(o);
            });
        };

        // CORRE√á√ÉO: Agora exibe a percentagem (%) ao lado do nome do ingrediente
        window.calcularMistura = () => {
            const meta = Number(document.getElementById('meta-kg').value);
            const key = document.getElementById('select-racao').value;
            const res = document.getElementById('resultado-pesagem');
            if(!meta || !key) return res.innerHTML = "";
            const r = receitasSalvas.find(x => x.fbKey === key);
            let h = `<div class="resultado-card"><div style="text-align:center;font-weight:bold;margin-bottom:10px;color:var(--verde-escuro)">${r.nome.toUpperCase()} - ${meta}kg</div>`;
            r.ingredientes.forEach(i => {
                const pesoCalculado = (meta*(i.porcentagem/100)).toFixed(2);
                h += `<div class="item-pesagem">
                        <span class="item-nome">${i.nome} (${i.porcentagem}%)</span>
                        <b class="item-valor">${pesoCalculado}kg</b>
                      </div>`;
            });
            res.innerHTML = h + `</div><button class="btn btn-main" style="margin-top:10px; background:#64748b;" onclick="window.print()">üñ®Ô∏è IMPRIMIR</button>`;
        };
    </script>
</body>
</html>