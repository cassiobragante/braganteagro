<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Bragante Agro</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@800&family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0a3d1d">
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>
    <style>
        :root { --verde-escuro: #0a3d1d; --verde-claro: #2e7d32; --vermelho-alerta: #c62828; --cinza-pendente: #94a3b8; --neutro-bg: #f1f5f9; --neutro-borda: #cbd5e1; --texto-principal: #1e293b; }
        body { font-family: 'Inter', sans-serif; background-color: var(--neutro-bg); margin: 0; padding: 0; color: var(--texto-principal); display: flex; justify-content: center; -webkit-tap-highlight-color: transparent; } 
        .app-container { width: 100%; max-width: 500px; background-color: #f8fafc; min-height: 100vh; padding: 15px; box-sizing: border-box; }
        .header { text-align: center; margin-bottom: 20px; }
        .header h1 { margin: 0; font-size: 22px; font-weight: 900; }
        .header .bragante { color: var(--verde-escuro); }
        .header .agro { color: var(--verde-claro); }
        .card { background: #ffffff; padding: 16px; border-radius: 10px; border: 1px solid var(--neutro-borda); margin-bottom: 12px; }
        .section-title { font-size: 11px; font-weight: 700; color: var(--verde-escuro); text-transform: uppercase; margin-bottom: 12px; display: flex; justify-content: space-between; }
        .form-row { display: flex; gap: 10px; margin-bottom: 12px; }
        input, select, textarea { width: 100%; padding: 10px; border-radius: 6px; border: 1px solid var(--neutro-borda); font-size: 14px; box-sizing: border-box; }
        .grid-prod { display: grid; grid-template-columns: 2fr 1fr 1fr 30px; gap: 8px; margin-bottom: 8px; align-items: center; }
        button { cursor: pointer; border-radius: 6px; font-weight: 600; border: none; text-transform: uppercase; }
        .btn-main { background: var(--verde-escuro); color: white; padding: 14px; width: 100%; margin-top: 10px; }
        .btn-add { background: transparent; color: var(--verde-claro); border: 1px dashed var(--verde-claro); padding: 9px; width: 100%; margin-bottom: 12px; }
        .btn-nav-group { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; margin-bottom: 10px; }
        .btn-nav { background: #64748b; color: white; padding: 10px; font-size: 9px; }
        .btn-nav.active { background: var(--verde-escuro); }
        .btn-report { background: #94a3b8; color: white; padding: 12px; width: 100%; margin-bottom: 20px; }
        .pedido-item { background: white; padding: 14px; border-radius: 10px; margin-bottom: 12px; border: 1px solid var(--neutro-borda); border-left-width: 6px; border-left-style: solid; position: relative; }
        .tag { font-size: 9px; font-weight: 700; padding: 4px 8px; border-radius: 4px; background: #e2e8f0; margin-right: 5px; }
        .tag-verde { background: #dcfce7; color: #166534; }
        .actions { display: flex; gap: 6px; margin-top: 12px; }
        .btn-mini { flex: 1; padding: 10px; font-size: 10px; background: #f8fafc; border: 1px solid var(--neutro-borda); }
        .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:100; align-items:center; justify-content:center; }
        .modal-content { background:white; padding:20px; border-radius:12px; width:80%; max-width: 300px; text-align: center; }
        
        #filtro-produto-relatorio { margin-bottom: 10px; }

        /* Estilos de Impressão */
        #print-section { display: none; }
        @media print {
            body * { visibility: hidden; }
            #print-section, #print-section * { visibility: visible; }
            #print-section { position: absolute; left: 0; top: 0; width: 100%; display: block !important; }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <h1><span class="bragante">BRAGANTE</span> <span class="agro">AGRO</span></h1>
            <div style="font-size: 18px; font-weight: 800; color: var(--verde-escuro); border-top: 1px solid #ddd; margin-top: 10px; padding-top: 5px;">PEDIDOS</div>
        </div>

        <div class="card">
            <div class="section-title">NOVO PEDIDO</div>
            <div class="form-row">
                <div style="flex:1"><label style="font-size:10px">Data</label><input type="date" id="data"></div>
                <div style="flex:2"><label style="font-size:10px">Cliente</label>
                    <select id="cliente" onchange="verificarNovoCliente(this)">
                        <option value="">Selecione...</option>
                        <option value="NOVO_CLIENTE">+ NOVO CLIENTE...</option>
                    </select>
                </div>
            </div>
            <div id="container-produtos"></div>
            <button class="btn-add" onclick="adicionarLinhaProduto()">+ Adicionar Item</button>
            <textarea id="descricao" rows="2" placeholder="Observações..."></textarea>
            <input type="hidden" id="edit-id">
            <button class="btn-main" onclick="salvarPedido()">SALVAR PEDIDO</button>
            <button id="btn-cancelar" onclick="cancelarEdicao()" style="display:none; width:100%; margin-top:5px; padding:10px;">CANCELAR</button>
        </div>

        <div class="btn-nav-group">
            <button id="nav-entregas" class="btn-nav active" onclick="mudarModo('entregas')">ENTREGAS</button>
            <button id="nav-pagamentos" class="btn-nav" onclick="mudarModo('pagamentos')">PAGAMENTOS</button>
            <button id="nav-todos" class="btn-nav" onclick="mudarModo('todos')">TODOS</button>
        </div>

        <div class="card">
            <label style="font-size: 10px; font-weight: bold;">FILTRAR PRODUTO NO RELATÓRIO:</label>
            <select id="filtro-produto-relatorio">
                <option value="">Todos os Produtos</option>
            </select>
            <button class="btn-report" onclick="gerarRelatorioImpressao()">IMPRIMIR RELATÓRIO</button>
        </div>
        
        <div id="listaPedidos"></div>
    </div>

    <div id="modalPagamento" class="modal"><div class="modal-content"><h3>Pagamento</h3><button onclick="selecionarForma('Pix')" class="btn-main" style="background:#14b8a6; margin-bottom:5px">PIX</button><button onclick="selecionarForma('Dinheiro')" class="btn-main" style="background:#22c55e; margin-bottom:5px">DINHEIRO</button><button onclick="selecionarOutros()" class="btn-main" style="background:#64748b">OUTROS</button><button onclick="fecharModal()" style="margin-top:10px; background:none; color:gray">FECHAR</button></div></div>
    
    <div id="print-section"></div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyCiQh8MEy5SlPCkS8psN0EQ59W2PLKXo8s", authDomain: "bragante-agro.firebaseapp.com", databaseURL: "https://bragante-agro-default-rtdb.firebaseio.com", projectId: "bragante-agro", storageBucket: "bragante-agro.firebasestorage.app", messagingSenderId: "445413217691", appId: "1:445413217691:web:e9b37451c2689a007e7d3e" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let todosPedidos = [], modoAtual = 'entregas', contadorProdutos = 0, pedidoEmPagamento = "";

        db.ref('pedidos').on('value', (snap) => {
            todosPedidos = []; snap.forEach(c => { todosPedidos.push(c.val()); });
            todosPedidos.sort((a,b) => b.timestamp - a.timestamp);
            atualizarListasMenu(); listarPedidos();
        });

        function adicionarLinhaProduto(p="", q=1, v="") {
            contadorProdutos++; const div = document.createElement('div'); div.className = 'grid-prod'; div.id = `linha-${contadorProdutos}`;
            div.innerHTML = `<input type="text" id="prod-${contadorProdutos}" value="${p}" placeholder="Produto"><input type="number" id="qtd-${contadorProdutos}" value="${q}" placeholder="Qtd"><input type="number" id="preco-${contadorProdutos}" value="${v}" step="0.01" placeholder="R$"><button onclick="this.parentElement.remove()" style="color:red">×</button>`;
            document.getElementById('container-produtos').appendChild(div);
        }

        function salvarPedido() {
            const idEdit = document.getElementById('edit-id').value, cliente = document.getElementById('cliente').value, data = document.getElementById('data').value;
            if(!cliente || !data) return alert("Preencha cliente e data");
            let itens = [], total = 0; document.querySelectorAll('.grid-prod').forEach(l => { 
                const idNum = l.id.split('-')[1], p = document.getElementById(`prod-${idNum}`).value;
                if(p) { const q = parseInt(document.getElementById(`qtd-${idNum}`).value), v = parseFloat(document.getElementById(`preco-${idNum}`).value) || 0; itens.push({produto: p, qtd: q, preco: v}); total += (q * v); }
            });
            const dados = { data, cliente, itens, total, timestamp: firebase.database.ServerValue.TIMESTAMP };
            if(idEdit) db.ref('pedidos/'+idEdit).update({...dados, editado: true}).then(cancelarEdicao);
            else { const nid = db.ref('pedidos').push().key; db.ref('pedidos/'+nid).set({...dados, id: nid, entrega: 'Pendente', pagamento: 'Pendente', formaPg: ''}).then(cancelarEdicao); }
        }

        function listarPedidos() {
            const lista = document.getElementById('listaPedidos'); lista.innerHTML = "";
            todosPedidos.filter(p => modoAtual === 'entregas' ? p.entrega === 'Pendente' : (modoAtual === 'pagamentos' ? p.pagamento === 'Pendente' : true)).forEach(p => {
                const cor = p.entrega === 'Entregue' ? (p.pagamento === 'Pago' ? "var(--verde-claro)" : "var(--vermelho-alerta)") : "var(--cinza-pendente)";
                lista.innerHTML += `<div class="pedido-item" style="border-left-color: ${cor}">
                    <div style="font-weight:700">${p.cliente} - ${p.data.split('-').reverse().join('/')}</div>
                    <div style="font-size:12px">${p.itens.map(i=>`${i.qtd}x ${i.produto}`).join(', ')}</div>
                    <div class="actions">
                        <button class="btn-mini" onclick="prepararEdicao('${p.id}')">EDITAR</button>
                        <button class="btn-mini" onclick="confirmarEntrega('${p.id}')">${p.entrega === 'Entregue' ? 'ESTORNAR' : 'ENTREGAR'}</button>
                        <button class="btn-mini" onclick="gerenciarPgto('${p.id}')">${p.pagamento === 'Pago' ? 'ESTORNAR' : 'PAGAR'}</button>
                    </div>
                </div>`;
            });
        }

        function gerarRelatorioImpressao() {
            const printSection = document.getElementById('print-section');
            const filtroProd = document.getElementById('filtro-produto-relatorio').value;
            
            const pedidos = todosPedidos.filter(p => 
                modoAtual === 'entregas' ? p.entrega === 'Pendente' : 
                (modoAtual === 'pagamentos' ? p.pagamento === 'Pendente' : true)
            );

            if(pedidos.length === 0) return alert("Nada para imprimir");

            let totalGeralDinheiro = 0;
            let totalGeralQtd = 0;

            let h = `
                <div style="padding:20px; font-family:'Inter', sans-serif;">
                    <div style="text-align:center; border-bottom:2px solid #0a3d1d; padding-bottom:10px; margin-bottom:20px;">
                        <h1 style="margin:0;"><span style="color:#0a3d1d;">BRAGANTE</span> <span style="color:#2e7d32;">AGRO</span></h1>
                        <p style="text-transform:uppercase; font-size:12px; font-weight:bold; margin:5px 0;">Relatório de Pedidos - ${modoAtual.toUpperCase()}</p>
                        ${filtroProd ? `<p style="font-size:11px; font-weight:bold;">Produto Filtrado: ${filtroProd}</p>` : ''}
                    </div>`;

            pedidos.forEach(p => {
                // Filtra apenas os itens que correspondem ao filtro (ou todos se vazio)
                const itensParaMostrar = p.itens.filter(i => filtroProd === "" || i.produto === filtroProd);
                
                if (itensParaMostrar.length > 0) {
                    h += `
                    <div style="margin-bottom:10px; padding:10px; border-bottom:1px solid #ddd;">
                        <div style="display:flex; justify-content:space-between; font-weight:bold;">
                            <span>${p.cliente}</span>
                            <span>${p.data.split('-').reverse().join('/')}</span>
                        </div>
                        <div style="font-size:13px; margin-top:5px;">`;
                    
                    itensParaMostrar.forEach(i => {
                        const sub = i.qtd * i.preco;
                        totalGeralDinheiro += sub;
                        totalGeralQtd += i.qtd;
                        h += `<div>• ${i.qtd}x ${i.produto} - R$ ${sub.toFixed(2)}</div>`;
                    });

                    h += `</div></div>`;
                }
            });

            h += `
                <div style="margin-top:20px; padding:15px; background:#f1f5f9; border:1px solid #0a3d1d; border-radius:8px;">
                    <div style="display:flex; justify-content:space-between; font-weight:900;">
                        <span>TOTAL DE PRODUTOS:</span>
                        <span>${totalGeralQtd} unidades</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; font-weight:900; color:#0a3d1d; font-size:18px; margin-top:5px;">
                        <span>TOTAL GERAL:</span>
                        <span>R$ ${totalGeralDinheiro.toFixed(2)}</span>
                    </div>
                </div>
            </div>`;

            printSection.innerHTML = h;
            window.print();
            
            // Limpa após a impressão para não travar a tela
            setTimeout(() => { printSection.innerHTML = ""; }, 500);
        }

        function prepararEdicao(id) { const p = todosPedidos.find(x => x.id === id); document.getElementById('edit-id').value = p.id; document.getElementById('cliente').value = p.cliente; document.getElementById('data').value = p.data; document.getElementById('container-produtos').innerHTML = ""; p.itens.forEach(i => adicionarLinhaProduto(i.produto, i.qtd, i.preco)); document.getElementById('btn-cancelar').style.display='block'; window.scrollTo(0,0); }
        function cancelarEdicao() { document.getElementById('edit-id').value = ""; document.getElementById('cliente').value = ""; document.getElementById('container-produtos').innerHTML = ""; document.getElementById('btn-cancelar').style.display='none'; adicionarLinhaProduto(); }
        function mudarModo(m) { modoAtual = m; document.querySelectorAll('.btn-nav').forEach(b => b.classList.remove('active')); document.getElementById('nav-'+m).classList.add('active'); listarPedidos(); }
        function confirmarEntrega(id) { const p = todosPedidos.find(x=>x.id===id); db.ref('pedidos/'+id).update({entrega: p.entrega === 'Entregue' ? 'Pendente' : 'Entregue'}); }
        function gerenciarPgto(id) { const p = todosPedidos.find(x=>x.id===id); if(p.pagamento === 'Pago') db.ref('pedidos/'+id).update({pagamento:'Pendente', formaPg:''}); else { pedidoEmPagamento = id; document.getElementById('modalPagamento').style.display='flex'; } }
        function selecionarForma(f) { db.ref('pedidos/'+pedidoEmPagamento).update({pagamento:'Pago', formaPg:f}); fecharModal(); }
        function selecionarOutros() { const f = prompt("Forma de Pgto:"); if(f) selecionarForma(f); }
        function fecharModal() { document.getElementById('modalPagamento').style.display='none'; }
        
        function atualizarListasMenu() { 
            const sc = document.getElementById('cliente'), fr = document.getElementById('filtro-produto-relatorio'), cSet = new Set(), pSet = new Set(); 
            todosPedidos.forEach(p => {
                cSet.add(p.cliente);
                p.itens.forEach(i => pSet.add(i.produto));
            }); 
            const valC = sc.value; 
            sc.innerHTML = '<option value="">Selecione...</option><option value="NOVO_CLIENTE">+ NOVO CLIENTE...</option>'; 
            [...cSet].sort().forEach(c => sc.add(new Option(c, c))); sc.value = valC; 
            
            const valP = fr.value;
            fr.innerHTML = '<option value="">Todos os Produtos</option>';
            [...pSet].sort().forEach(p => fr.add(new Option(p, p))); fr.value = valP;
        }

        function verificarNovoCliente(s) { if(s.value === "NOVO_CLIENTE") { const n = prompt("Nome:"); if(n) { const o = new Option(n, n); s.add(o); s.value = n; } } }
        document.getElementById('data').valueAsDate = new Date(); adicionarLinhaProduto();
    </script>
</body>
</html>